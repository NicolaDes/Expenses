{% extends "base.html" %}

{% block title %}Utilities{% endblock %}

{% block content %}

<section>
    <h2>Gestione Backup</h2>

    <a href="/utilities/backup/export">
        <button type="button">ðŸ“¥ Scarica backup</button>
    </a>

    <form id="restore-form" method="post" action="/utilities/restore" enctype="multipart/form-data">
        <input type="file" name="backup_file" id="backup-file">
        <button type="submit">Ripristina</button>
    </form>

    <div id="restore-overlay" class="overlay hidden">
        <div class="loader"></div>
    </div>



    <div id="restore-modal" class="modal hidden">
        <div class="modal-content">
            <span id="close-modal" class="modal-close">&times;</span>
            <h3>Restore completed</h3>
            <ul id="restore-summary">
            </ul>
        </div>
    </div>

</section>

<script type="module">
    const overlay = document.getElementById("restore-overlay");
    const modal = document.getElementById("restore-modal");
    const summaryUl = document.getElementById("restore-summary");

    document.getElementById("restore-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!confirm("Questa operazione eliminerÃ  tutti i dati esistenti. Procedere?")) return;

        const form = e.target;
        const formData = new FormData(form);

        overlay.classList.remove("hidden");

        try {
            const res = await fetch(form.action, { method: "POST", body: formData });
            if (!res.ok) throw new Error("Errore durante il restore");

            const data = await res.json();

            summaryUl.innerHTML = `
            <li>Account importati: ${data.accounts}</li>
            <li>Categorie importate: ${data.categories}</li>
            <li>Regole importate: ${data.rules}</li>
            <li>Budgets importati: ${data.budgets}</li>
            <li>Transazioni importate: ${data.transactions}</li>
            <li>Account rules importate: ${data.account_rules}</li>
            <li>Settings importate: ${data.settings}</li>
        `;

            modal.style.display = "flex";

        } catch (err) {
            alert(err);
        } finally {
            overlay.classList.add("hidden");
        }
    });

    document.getElementById("close-modal").addEventListener("click", () => {
        modal.style.display = "none";
    });

</script>

{% endblock %}