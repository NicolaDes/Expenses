{% extends "base_account.html" %}

{% block title %}Account: {{ account.name }}{% endblock %}

{% block content %}


<div class="cards-dashboard">
    <div class="card card-area-main card-large">
        <div class="card-header">
            <form id="date-filter-form" class="minimal-form">

                <div class="form-row">
                    <div class="form-col">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date" name="start_date" value="{{ period_stats.start_date }}">
                    </div>
                    <div class="form-col">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date" name="end_date" value="{{ period_stats.end_date }}">
                    </div>
                    <div class="form-col">
                        <button type="submit" class="btn-submit">Filter</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="card-body">
            <div class="cards-flex-grid">
                <div class="chart-card stat-card card-span-4 card-row-span-2">
                    <h4>ðŸ“ˆ Montly Trend</h4>
                    <canvas id="montlyTrendChart"></canvas>
                </div>

                <div class="chart-card stat-card card-span-4 card-row-span-2">
                    <h4>ðŸ“Š Montly Income vs Outcome</h4>
                    <canvas id="incomeVsExpenseChart"></canvas>
                </div>

                <div class="chart-card stat-card card-span-2 card-row-span-2">
                    <h4>ðŸ’° Category Income</h4>
                    <canvas id="incomeByCategory"></canvas>
                </div>

                <div class="chart-card stat-card card-span-2 card-row-span-2">
                    <h4>ðŸ’¸ Category Expenses</h4>
                    <canvas id="expenseByCategory"></canvas>
                </div>

                <div class="chart-card stat-card card-span-4 card-row-span-2">
                    <h4>ðŸ’¸ Macro Category Expenses</h4>
                    <canvas id="expenseByMacroCategory"></canvas>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ’¸ Total Income</h3>
                    <p id="stat-income" class="stat-value negative">â‚¬ </p>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ’¸ Total Expenses</h3>
                    <p id="stat-expense" class="stat-value negative">â‚¬ </p>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ’° Net balance</h3>
                    <p id="stat-balance" class="stat-value">â‚¬ </p>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ“Š Used Transactions for analytics in current period</h3>
                    <p id="stat-transactions" class="stat-value"></p>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ“ˆ Mean montly income</h3>
                    <p id="stat-avg-income" class="stat-value">â‚¬ </p>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ“‰ Mean montly expenses</h3>
                    <p id="stat-avg-expense" class="stat-value">â‚¬ </p>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-span-4">
        <div class="card-header">
            <input type="text" id="table-global-filter" placeholder="ðŸ” Find transaction..." />
        </div>
        <div class="card-body">
            <div id="transactions-table" class="tabulator custom-theme"></div>
        </div>
    </div>

    <div class="card card-area-sidebar card-large">
        <div class="card-body">
            <form id="upload-form" class="minimal-form" action="/accounts/{{ account.id }}/upload" method="post"
                enctype="multipart/form-data">
                <div class="form-row">
                    <label for="transaction-file">File CSV/Excel</label>
                </div>
                <div class="form-row">
                    <div class="dropzone">
                        Drag and drop the transactions file or click to select it
                        <input id="transaction-file" type="file" name="file" required>
                    </div>
                </div>
                <div class="form-row">
                    <button type="submit" class="btn-submit">Upload</button>
                </div>
            </form>
        </div>
    </div>

</div>

<div id="upload-overlay" class="overlay hidden">
    <div class="loader"></div>
</div>

<div id="upload-modal" class="modal hidden">
    <div class="modal-content">
        <span id="close-modal" class="modal-close">&times;</span>
        <h3>Upload completed</h3>
        <ul id="upload-summary">
        </ul>
    </div>
</div>

<script type="module">
    import { createLineChart, createPieChart, createMultiLineChart } from "/static/js/charts.js";

    async function update_charts() {
        const accountId = document.body.dataset.accountId;

        const montlyChartId = "montlyTrendChart";
        const incomePieId = "incomeByCategory";
        const expensePieId = "expenseByCategory";
        const multiLineId = "incomeVsExpenseChart";
        const expenseByMacroCategory = "expenseByMacroCategory";

        const start = document.getElementById("start-date").value;
        const end = document.getElementById("end-date").value;

        if (!start || !end) return alert("Seleziona entrambe le date");

        try {
            const res = await fetch(`/accounts/${accountId}/charts?start=${start}&end=${end}`);
            if (!res.ok) throw new Error("Unable to retrieve charts data");

            const data = await res.json();

            createLineChart(montlyChartId, data.montly_labels, data.montly_expenses, "expenses");
            createPieChart(incomePieId, data.income_categories, data.income_values);
            createPieChart(expensePieId, data.expense_categories_category, data.expense_values_category);
            createPieChart(expenseByMacroCategory, data.expense_categories_macrocategory, data.expense_values_macrocategory);

            createMultiLineChart(multiLineId, data.montly_labels, [
                { label: "Income", data: data.montly_income },
                { label: "Outcome", data: data.montly_expenses }
            ]);

            const parseNum = (val) => {
                const n = Number(val);
                return isNaN(n) ? 0 : n;
            };

            const formatEur = (val) => `â‚¬ ${parseNum(val).toFixed(2)}`;



            document.getElementById("stat-income").textContent = formatEur(data.income);
            document.getElementById("stat-expense").textContent = formatEur(data.expenses);
            document.getElementById("stat-balance").textContent = formatEur(data.net_balance);
            document.getElementById("stat-transactions").textContent = `${data.transactions_count_used} / ${data.transactions_count}`;
            document.getElementById("stat-avg-income").textContent = formatEur(data.mean_montly_income);
            document.getElementById("stat-avg-expense").textContent = formatEur(data.mean_montly_expenses);


        } catch (err) {
            console.error(err);
            alert("Unable to update charts...");
        }
    }

    const form = document.getElementById("date-filter-form");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        await update_charts();
    });

    update_charts();

</script>

<script type="module">
    import { initTable, deleteFromTable } from "/static/js/tables.js";

    const data = [
        {% for t in transactions %}
    { id: "{{ t.txt.id }}", date: "{{ t.txt.date }}", description: "{{ t.txt.description }}", category_name: "{{ t.category_name }}", value: "{{ t.txt.value }} â‚¬", perc_to_exclude: "{{ t.txt.perc_to_exclude }} %" },
    {% endfor %}
  ];

    const columns = [
        { title: "Date", field: "date", sorter: "date", hozAlign: "center" },
        { title: "Description", field: "description", sorter: "string" },
        { title: "Category", field: "category_name", sorter: "string" },
        { title: "Value", field: "value", sorter: "number" },
        { title: "Excluded percentage", field: "perc_to_exclude", sorter: "number" },
        {
            title: "",
            hozAlign: "center",
            width: 60,
            formatter: () => `<button class="delete-btn">ðŸ’€</button>`,
            cellClick: (e, cell) => {
                const rowData = cell.getRow().getData();
                const row = cell.getRow();

                const path = `/transactions/${rowData.id}`;
                const message = `Sei sicuro di voler eliminare questa transazione?`;

                deleteFromTable(path, message, row);
            }
        }
    ];

    const table = initTable("#transactions-table", columns, data);

    document.getElementById("table-global-filter").addEventListener("keyup", function () {
        const val = this.value.toLowerCase();
        table.setFilter([
            [
                { field: "date", type: "like", value: val },
                { field: "description", type: "like", value: val },
                { field: "category_name", type: "like", value: val },
                { field: "value", type: "like", value: val },
                { field: "perc_to_exclude", type: "like", value: val },
            ]
        ]);
    });

    const overlay = document.getElementById("upload-overlay");
    const modal = document.getElementById("upload-modal");
    const summaryUl = document.getElementById("upload-summary");

    document.getElementById("upload-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!confirm("Stai per importare delle transazioni. Procedere?")) return;

        const form = e.target;
        const formData = new FormData(form);

        overlay.classList.remove("hidden");

        try {
            const res = await fetch(form.action, { method: "POST", body: formData });
            if (!res.ok) throw new Error("Errore durante l'upload!");

            const data = await res.json();

            summaryUl.innerHTML = `<li>Transazioni importate: ${data.rows_imported}</li>`;

            modal.style.display = "flex";
        } catch (err) {
            alert(err);
        } finally {
            overlay.classList.add("hidden");
        }
    });

    document.getElementById("close-modal").addEventListener("click", () => {
        modal.style.display = "none";
    });

</script>
{% endblock %}