{% extends "base_account.html" %}

{% block title %}Account: {{ account.name }}{% endblock %}

{% block content %}
<h1>{{ account.name }}</h1>

<div class="account-page-container">
    <section class="transactions-section">
        <h2>Transactions</h2>

        <input type="text" id="table-global-filter" placeholder="🔍 Find..." />

        <div id="transactions-table" class="tabulator custom-theme"></div>
    </section>

    <section class="stats-section">
        <h2>Statistiche</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Totale Entrate</h3>
                <p>{{ total_income }}</p>
            </div>
            <div class="stat-card">
                <h3>Totale Uscite</h3>
                <p>{{ total_expense }}</p>
            </div>
        </div>
    </section>

    <section class="form-section upload-section">
        <h2>Upload Transactions</h2>
        <form id="upload-form" class="minimal-form" action="/accounts/{{ account.id }}/upload" method="post"
            enctype="multipart/form-data">
            <div class="form-row">
                <label for="transaction-file">File CSV/Excel</label>
                <div class="dropzone">
                    Trascina qui il file o clicca per selezionarlo
                    <input id="transaction-file" type="file" name="file" required>
                </div>
            </div>
            <div class="form-row">
                <button type="submit" class="btn-submit">Carica</button>
            </div>
        </form>
    </section>

</div>

<div id="upload-overlay" class="overlay hidden">
    <div class="loader"></div>
</div>

<div id="upload-modal" class="modal hidden">
    <div class="modal-content">
        <span id="close-modal" class="modal-close">&times;</span>
        <h3>Upload completed</h3>
        <ul id="upload-summary">
        </ul>
    </div>
</div>

<script type="module">
    import { initTable, deleteFromTable } from "/static/js/tables.js";

    const data = [
        {% for t in transactions %}
    { id: "{{ t.txt.id }}", date: "{{ t.txt.date }}", description: "{{ t.txt.description }}", category_name: "{{ t.category_name }}", value: "{{ t.txt.value }} €", perc_to_exclude: "{{ t.txt.perc_to_exclude }} %" },
    {% endfor %}
  ];

    const columns = [
        { title: "Date", field: "date", sorter: "date", hozAlign: "center" },
        { title: "Description", field: "description", sorter: "string" },
        { title: "Category", field: "category_name", sorter: "string" },
        { title: "Value", field: "value", sorter: "number" },
        { title: "Excluded percentage", field: "perc_to_exclude", sorter: "number" },
        {
            title: "",
            hozAlign: "center",
            width: 60,
            formatter: () => `<button class="delete-btn">💀</button>`,
            cellClick: (e, cell) => {
                const rowData = cell.getRow().getData();
                const row = cell.getRow();

                const path = `/transactions/${rowData.id}`;
                const message = `Sei sicuro di voler eliminare questa transazione?`;

                deleteFromTable(path, message, row);
            }
        }
    ];

    const table = initTable("#transactions-table", columns, data);

    document.getElementById("table-global-filter").addEventListener("keyup", function () {
        const val = this.value.toLowerCase();
        table.setFilter([
            [
                { field: "date", type: "like", value: val },
                { field: "description", type: "like", value: val },
                { field: "category_name", type: "like", value: val },
                { field: "value", type: "like", value: val },
                { field: "perc_to_exclude", type: "like", value: val },
            ]
        ]);
    });

    const overlay = document.getElementById("upload-overlay");
    const modal = document.getElementById("upload-modal");
    const summaryUl = document.getElementById("upload-summary");

    document.getElementById("upload-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!confirm("Stai per importare delle transazioni. Procedere?")) return;

        const form = e.target;
        const formData = new FormData(form);

        overlay.classList.remove("hidden");

        try {
            const res = await fetch(form.action, { method: "POST", body: formData });
            if (!res.ok) throw new Error("Errore durante l'upload!");

            const data = await res.json();

            summaryUl.innerHTML = `<li>Transazioni importate: ${data.rows_imported}</li>`;

            modal.style.display = "flex";
        } catch (err) {
            alert(err);
        } finally {
            overlay.classList.add("hidden");
        }
    });

    document.getElementById("close-modal").addEventListener("click", () => {
        modal.style.display = "none";
    });

</script>
{% endblock %}