{% extends "base_account.html" %}

{% block title %}Account: {{ account.name }}{% endblock %}

{% block content %}


<div class="cards-dashboard">
    <div class="card card-area-main card-large">
        <div class="card-header">
            <form id="date-filter-form" class="minimal-form">

                <div class="form-row">
                    <div class="form-col">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date" name="start_date" value="{{ period_stats.start_date }}">
                    </div>
                    <div class="form-col">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date" name="end_date" value="{{ period_stats.end_date }}">
                    </div>
                    <div class="form-col">
                        <button type="submit" class="btn btn-ghost btn-sm">Filter</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="card-body">
            <div class="cards-flex-grid">
                <div class="chart-card stat-card card-span-4 card-row-span-2">
                    <h4>ðŸ“ˆ Montly Trend</h4>
                    <canvas id="montlyTrendChart"></canvas>
                </div>

                <div class="chart-card stat-card card-span-4 card-row-span-2">
                    <h4>ðŸ“Š Montly Income vs Outcome</h4>
                    <canvas id="incomeVsExpenseChart"></canvas>
                </div>

                <div class="chart-card stat-card card-span-2 card-row-span-2">
                    <h4>ðŸ’° Category Income</h4>
                    <canvas id="incomeByCategory"></canvas>
                </div>

                <div class="chart-card stat-card card-span-2 card-row-span-2">
                    <h4>ðŸ’¸ Category Expenses</h4>
                    <canvas id="expenseByCategory"></canvas>
                </div>

                <div class="chart-card stat-card card-span-4 card-row-span-2">
                    <h4>ðŸ’¸ Macro Category Expenses</h4>
                    <canvas id="expenseByMacroCategory"></canvas>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ’¸ Total Income</h3>
                    <p id="stat-income" class="stat-value negative">â‚¬ </p>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ’¸ Total Expenses</h3>
                    <p id="stat-expense" class="stat-value negative">â‚¬ </p>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ’° Net balance</h3>
                    <p id="stat-balance" class="stat-value">â‚¬ </p>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ“Š Used Transactions for analytics in current period</h3>
                    <p id="stat-transactions" class="stat-value"></p>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ“ˆ Mean montly income</h3>
                    <p id="stat-avg-income" class="stat-value">â‚¬ </p>
                </div>

                <div class="stat-card card-span-2 card-row-span-1">
                    <h3>ðŸ“‰ Mean montly expenses</h3>
                    <p id="stat-avg-expense" class="stat-value">â‚¬ </p>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-area-sidebar card-large">
        <div class="cards-stack">
            <div class="card stat-card">
                <div class="card-header">
                    <label for="transaction-file">File CSV/Excel</label>
                </div>
                <div class="card-body">
                    <form id="upload-form" class="minimal-form" action="/accounts/{{ account.id }}/upload" method="post"
                        enctype="multipart/form-data">
                        <div class="form-row">
                            <div class="dropzone">
                                Drag and drop the transactions file or click to select it
                                <input id="transaction-file" type="file" name="file" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-ghost btn-sm">Upload</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card stat-card">
                <div class="card-header">
                    <h2>Report data range</h2>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <form class="minimal-form" id="download-report-form" action="/accounts/{{ account.id }}/report"
                            method="get">
                            <div class="form-row">
                                <label for="start-date-report"></label>
                                <input type="date" id="start-date-report" name="start">
                            </div>
                            <div class="form-row">
                                <label for="end-date-report"></label>
                                <input type="date" id="end-date-report" name="end">
                            </div>
                            <div class="form-row">
                                <button type="submit" class="btn btn-ghost btn-sm">ðŸ“¥ Download report</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="upload-overlay" class="overlay hidden">
    <div class="loader"></div>
</div>

<div id="upload-modal" class="modal hidden">
    <div class="modal-content">
        <span id="close-modal" class="modal-close">&times;</span>
        <h3>Upload completed</h3>
        <ul id="upload-summary">
        </ul>
    </div>
</div>

<script type="module">
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const end = new Date(now.getFullYear(), now.getMonth(), 0);

    const pad = n => n.toString().padStart(2, '0');
    const format = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

    document.getElementById('start-date-report').value = format(start);
    document.getElementById('end-date-report').value = format(end);

</script>

<script type="module">
    import { createLineChart, createPieChart, createMultiLineChart } from "/static/js/charts.js";

    async function update_charts() {
        const accountId = document.body.dataset.accountId;

        const montlyChartId = "montlyTrendChart";
        const incomePieId = "incomeByCategory";
        const expensePieId = "expenseByCategory";
        const multiLineId = "incomeVsExpenseChart";
        const expenseByMacroCategory = "expenseByMacroCategory";

        const start = document.getElementById("start-date").value;
        const end = document.getElementById("end-date").value;

        if (!start || !end) return alert("Seleziona entrambe le date");

        try {
            const res = await fetch(`/accounts/${accountId}/charts?start=${start}&end=${end}`);
            if (!res.ok) throw new Error("Unable to retrieve charts data");

            const data = await res.json();

            createLineChart(montlyChartId, data.montly_labels, data.montly_expenses, "expenses");
            createPieChart(incomePieId, data.income_categories, data.income_values);
            createPieChart(expensePieId, data.expense_categories_category, data.expense_values_category);
            createPieChart(expenseByMacroCategory, data.expense_categories_macrocategory, data.expense_values_macrocategory);

            createMultiLineChart(multiLineId, data.montly_labels, [
                { label: "Income", data: data.montly_income },
                { label: "Outcome", data: data.montly_expenses }
            ]);

            const parseNum = (val) => {
                const n = Number(val);
                return isNaN(n) ? 0 : n;
            };

            const formatEur = (val) => `â‚¬ ${parseNum(val).toFixed(2)}`;



            document.getElementById("stat-income").textContent = formatEur(data.income);
            document.getElementById("stat-expense").textContent = formatEur(data.expenses);
            document.getElementById("stat-balance").textContent = formatEur(data.net_balance);
            document.getElementById("stat-transactions").textContent = `${data.transactions_count_used} / ${data.transactions_count}`;
            document.getElementById("stat-avg-income").textContent = formatEur(data.mean_montly_income);
            document.getElementById("stat-avg-expense").textContent = formatEur(data.mean_montly_expenses);


        } catch (err) {
            console.error(err);
            alert("Unable to update charts...");
        }
    }

    const form = document.getElementById("date-filter-form");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        await update_charts();
    });

    update_charts();

</script>

<script type="module">
    const overlay = document.getElementById("upload-overlay");
    const modal = document.getElementById("upload-modal");
    const summaryUl = document.getElementById("upload-summary");

    document.getElementById("upload-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!confirm("Stai per importare delle transazioni. Procedere?")) return;

        const form = e.target;
        const formData = new FormData(form);

        overlay.classList.remove("hidden");

        try {
            const res = await fetch(form.action, { method: "POST", body: formData });
            if (!res.ok) throw new Error("Errore durante l'upload!");

            const data = await res.json();

            summaryUl.innerHTML = `<li>Transazioni importate: ${data.rows_imported}</li>`;

            modal.style.display = "flex";
        } catch (err) {
            alert(err);
        } finally {
            overlay.classList.add("hidden");
        }
    });

    document.getElementById("close-modal").addEventListener("click", () => {
        modal.style.display = "none";
    });

</script>
{% endblock %}