{% extends "base_account.html" %}

{% block title %}Account: {{ account.name }}{% endblock %}

{% block content %}
<h1>{{ account.name }}</h1>

<div class="account-page-container">
    <section class="transactions-section">
        <h2>Transactions</h2>

        <input type="text" id="table-global-filter" placeholder="🔍 Find..." />

        <div id="transactions-table" class="tabulator custom-theme"></div>
    </section>

    <section class="stats-section">
        <h2>Statistiche</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Totale Entrate</h3>
                <p>{{ total_income }}</p>
            </div>
            <div class="stat-card">
                <h3>Totale Uscite</h3>
                <p>{{ total_expense }}</p>
            </div>
        </div>
    </section>

    <section class="form-section upload-section">
        <h2>Upload Transactions</h2>
        <form class="minimal-form" action="/accounts/{{ account.id }}/upload" method="post"
            enctype="multipart/form-data">
            <div class="form-row">
                <label for="transaction-file">File CSV/Excel</label>
                <div class="dropzone">
                    Trascina qui il file o clicca per selezionarlo
                    <input id="transaction-file" type="file" name="file" required>
                </div>
            </div>
            <div class="form-row">
                <button type="submit" class="btn-submit">Carica</button>
            </div>
        </form>
    </section>

</div>


<script type="module">
    import { initTable, deleteFromTable } from "/static/js/tables.js";

    const data = [
        {% for t in transactions %}
    { id: "{{ t.txt.id }}", date: "{{ t.txt.date }}", description: "{{ t.txt.description }}", category_name: "{{ t.category_name }}", value: "{{ t.txt.value }} €", perc_to_exclude: "{{ t.txt.perc_to_exclude }} %" },
    {% endfor %}
  ];

    const columns = [
        { title: "Date", field: "date", sorter: "date", hozAlign: "center" },
        { title: "Description", field: "description", sorter: "string" },
        { title: "Category", field: "category_name", sorter: "string" },
        { title: "Value", field: "value", sorter: "number" },
        { title: "Excluded percentage", field: "perc_to_exclude", sorter: "number" },
        {
            title: "",
            hozAlign: "center",
            width: 60,
            formatter: () => `<button class="delete-btn">💀</button>`,
            cellClick: (e, cell) => {
                const rowData = cell.getRow().getData();
                const row = cell.getRow();

                const path = `/transactions/${rowData.id}`;
                const message = `Sei sicuro di voler eliminare questa transazione?`;

                deleteFromTable(path, message, row);
            }
        }
    ];

    const table = initTable("#transactions-table", columns, data);

    document.getElementById("table-global-filter").addEventListener("keyup", function () {
        const val = this.value.toLowerCase();
        table.setFilter([
            [
                { field: "date", type: "like", value: val },
                { field: "description", type: "like", value: val },
                { field: "category_name", type: "like", value: val },
                { field: "value", type: "like", value: val },
                { field: "perc_to_exclude", type: "like", value: val },
            ]
        ]);
    });
</script>
{% endblock %}