{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}

<section>
    <h2>Gestione Backup</h2>

    <a href="/settings/backup/export">
        <button type="button">ðŸ“¥ Scarica backup</button>
    </a>

    <form id="restore-form" method="post" action="/settings/restore" enctype="multipart/form-data">
        <input type="file" name="backup_file" id="backup-file">
        <button type="submit">Ripristina</button>
    </form>


    <div id="restore-modal" class="modal hidden">
        <div class="modal-content">
            <span id="close-modal" class="modal-close">&times;</span>
            <h3>Restore completed</h3>
            <ul id="restore-summary">
            </ul>
        </div>
    </div>

    <script type="module">
        document.getElementById("restore-form").addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!confirm("Questa operazione eliminerÃ  tutti i dati esistenti. Procedere?")) return;

            const form = e.target;
            const formData = new FormData(form);

            try {
                const res = await fetch(form.action, { method: "POST", body: formData });
                if (!res.ok) throw new Error("Errore durante il restore");

                const data = await res.json();

                const summaryUl = document.getElementById("restore-summary");
                summaryUl.innerHTML = `
                    <li>Account importati: ${data.accounts}</li>
                    <li>Categorie importate: ${data.categories}</li>
                    <li>Regole importate: ${data.rules}</li>
                    <li>Budgets importati: ${data.budgets}</li>
                    <li>Transazioni importate: ${data.transactions}</li>
                    <li>Account rules importate: ${data.account_rules}</li>
                `;

                const modal = document.getElementById("restore-modal");
                modal.style.display = "flex";

            } catch (err) {
                alert(err);
            }
        });

        document.getElementById("close-modal").addEventListener("click", () => {
            document.getElementById("restore-modal").style.display = "none";
        });
    </script>

    {% endblock %}