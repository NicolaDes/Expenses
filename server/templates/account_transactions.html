{% extends "base_account.html" %}

{% block title %}Account: {{ account.name }}{% endblock %}

{% block content %}
<h1>{{ account.name }}</h1>

<div class="account-page-container">
    <section class="transactions-section">
        <h2>Transactions</h2>
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Value</th>
                    <th>Excluded percentage</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for t in transactions %}
                <tr class="transaction-row" data-id="{{ t.txt.id }}">
                    <td>{{ t.txt.date }}</td>
                    <td>{{ t.txt.description }}</td>
                    <td>{{ t.category_name }}</td>
                    <td>{{ t.txt.value }} â‚¬</td>
                    <td>{{ t.txt.perc_to_exclude }}%</td>
                    <td><button class="delete-btn">ðŸ’€</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <section class="form-section add-transaction-form">
        <h2>Add New Transaction</h2>
        <form class="minimal-form" method="post" action="/accounts/{{ account.id }}/transactions">

            <div class="form-row">
                <label for="tx-description">Description</label>
                <input id="tx-description" type="text" name="description" required>
            </div>

            <div class="form-row">
                <label for="tx-value">Value</label>
                <input id="tx-value" type="number" step="0.01" name="value" required>
            </div>

            <div class="form-row">
                <label for="tx-perc">Perc to Exclude</label>
                <input id="tx-perc" type="number" step="0.01" name="perc_to_exclude" value="0">
            </div>

            <div class="form-row">
                <label for="tx-label">Label</label>
                <input id="tx-label" type="text" name="label">
            </div>

            <div class="form-row">
                <label for="tx-date">Date</label>
                <input id="tx-date" type="datetime-local" name="date" required>
            </div>

            <div class="form-row">
                <label for="tx-category">Category</label>
                <select id="tx-category" name="category_id">
                    <option value="">-- Select a Category --</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.category }} - {{ category.macro_category }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <button type="submit" class="btn-submit">Add Transaction</button>
            </div>

        </form>
    </section>

</div>

<script type="module">
    import { deleteFromTable } from "/static/script.js";
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", async e => {
                const row = e.target.closest(".transaction-row");
                const id = row.dataset.id;
                const accountId = document.body.dataset.accountId;
                const path = `/transactions/${id}`;
                const message = `Sei sicuro di voler eliminare questa transazione?`;

                deleteFromTable(path, message, row);
            });
        });
    });
</script>
{% endblock %}